#!/bin/bash -e

[[ -d .git ]] || {
	echo "ERROR: must be at root of git workarea" 1>&2
	exit 1
}

[[ -d /opt/local ]] || {
  echo "ERROR: cannot coexist with macports" 1>&2
  exit 1
}

source bin/profile

pth_local="$(pwd)/local"

sudo ln -nfs $pth_local /opt/local

git submodule update --init

pushd MacPorts-1.9.2 > /dev/null
./configure --prefix="$pth_local" --with-install-user=$(id -u -n) --with-install-group=$(id -g -n)
make -j 2
make install
popd > /dev/null

perl -pe 's{/Users/defn/rackspace/pancake/macports}{$ENV{"PWD"}}; s{/Users/defn}{$ENV{"HOME"}}' "$pth_local/etc/macports/macports.conf.local" > "$pth_local/etc/macports/macports.conf"

pushd rvm > /dev/null
./install
popd > /dev/null

