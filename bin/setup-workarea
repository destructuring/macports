#!/bin/bash -e

[[ -d .git ]] || {
	echo "ERROR: must be at root of git workarea" 1>&2
	exit 1
}

[[ -d /opt/local && ! -L /opt/local ]] && {
  echo "ERROR: cannot coexist with macports" 1>&2
  exit 1
}

source bin/profile

rm -rf local MacPorts-1.9.2
git checkout local MacPorts-1.9.2

git submodule update --init

pth_local="$(pwd)/local"

sudo ln -nfs $pth_local /opt/local

pushd MacPorts-1.9.2 > /dev/null
./configure --prefix="$pth_local" --with-install-user=$(id -u -n) --with-install-group=$(id -g -n)
make -j 2
make install
popd > /dev/null

perl -pe 's{/Users/defn/rackspace/pancake/macports}{$ENV{"PWD"}}; s{/Users/defn}{$ENV{"HOME"}}' "$pth_local/etc/macports/macports.conf.local" > "$pth_local/etc/macports/macports.conf"

port install wget curl rsync cdrtools git-core gnupg runit nmap vim irssi openvpn 
port install mysql5 libxml2 libxslt tnef imagemagick
port install nodejs
port install dbus +no_root +no_startupitem
port install firefox-x11 +official_branding

pushd rvm > /dev/null
./install || true
popd > /dev/null

set +e
source $HOME/.rvm/scripts/rvm
rvm install ree-1.8.7-2011.03
rvm ree-1.8.7-2011.03 --default
rvm rubygems 1.5.3
set -e

gem install bundler -v 1.0.10

