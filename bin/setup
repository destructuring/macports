#!/bin/bash -e

if [[ ! -x local/bin/port ]]; then
	_pth_local="$(pwd)/local"

	rm -rf MacPorts-2.0.2
	git checkout MacPorts-2.0.2

  for a in local/etc/macports/*.template; do
    perl -pe 's{\$\$\$PANCAKE_ROOT\$\$\$}{$ENV{"PANCAKE_ROOT"}}e' $a > ${a%.template}
  done

  pushd MacPorts-2.0.2 > /dev/null

  ./configure --prefix="$_pth_local" --with-install-user=$(id -u -n) --with-install-group=$(id -g -n)
  make -j 2
  make install
  hash -r

  popd > /dev/null
fi
