#!/bin/bash -e

source .profile

sudo -p "[sudo]" chown $(id -un) /Library/LaunchAgents /Library/LaunchDaemons # TODO get rid of anything that installs to root Launch dirs

MACPORTS_VERSION="2.0.4"
rm -rf MacPorts-$MACPORTS_VERSION
git checkout MacPorts-$MACPORTS_VERSION

for a in local/etc/macports/*.template; do
  perl -pe 's{\$\$\$MACPORTS_ROOT\$\$\$}{$ENV{"PWD"}}eg' $a > ${a%.template} 
done

pushd MacPorts-$MACPORTS_VERSION > /dev/null
  ./configure --prefix="$MACPORTS_ROOT" --with-install-user=$(id -u -n) --with-install-group=$(id -g -n) --with-no-root-privileges
  make -j 2
  make install
  hash -r
popd > /dev/null
